---
title: "Practica Fundamentos"
author: "Juan - Jose - Moncef"
date: "17/12/2021"
output:
  html_document:
    theme: united
    code_folding: "hide"
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
#Librerias

library(tidyr)
library(date)
library(zoo)
#library(tidyverse)
library(ggplot2)
library(corrplot)
library(caret)
library(dplyr)
library(olsrr)
library(fastDummies)
library(pracma)
library(geosphere)
library(readxl)
library(glmnet)


library(readr)
library(naniar)
library(gridExtra)
library(grid)
library(lattice)
library(GGally)
```

## Introducción

Comentar

## Objetivos

Comentar

## Carga de datos

Lectura de datos, separación TRAIN vs TEST

```{r}
#Cargamos los datos y definimos una muestra train y otra test
data = as.data.frame(read_excel("/home/jl/Escritorio/Master DS/Proyecto_King_County/m/kc_house_data_vfinal.xlsx"))

dt = sort(sample(nrow(data), nrow(data)*.7))
train<-data[dt,]
test<-data[-dt,]
summary(train)
```

## EDA

EDA datos actuales, más variables nuevas que creamos


### Analisis de datos actuales

__Datos actuales__

```{r}
str(train)
```

### Variables cuantitativas

```{r}
var_cuant <- train[, c(3, 6, 20, 7, 21, 13, 14, 15, 16)]
str(var_cuant)
```


Se estudia la variable __precio__
```{r}
p1 <- ggplot(train, aes(x=price)) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p2 <- ggplot(train, aes(x=1)) + geom_boxplot(aes(y=price), colour = "navy", fill = "steelblue")
grid.arrange(p1, p2, nrow=1)
summary(train$price)
```

Se estudia la variable __sqft_living__
```{r}
p3 <- ggplot(train, aes(x=sqft_living)) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p4 <- ggplot(train, aes(x=1)) + geom_boxplot(aes(y=sqft_living), colour = "navy", fill = "steelblue")
grid.arrange(p3, p4, nrow=1)
summary(train$sqft_living)
```


Se estudia la variable __sqft_living15__
```{r}
p5 <- ggplot(train, aes(x=sqft_living15)) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p6 <- ggplot(train, aes(x=1)) + geom_boxplot(aes(y=sqft_living15), colour = "navy", fill = "steelblue")
grid.arrange(p5, p6, nrow=1)
summary(train$sqft_living15)
```


### Variables cualitativas

```{r}
var_cual <- train[, c(2, 4, 5, 8, 9 ,10 , 11, 12, 17)]
str(var_cual)
```

Se estudia la variable __date__
```{r}
train$date <- gsub("T000000","",as.character(train$date))
train$date <- as.Date(train[, 'date'],'%Y%m%d')
#str(train$date)

df_dateMonth <- format(train$date,"%m")
df_dateYear <- format(train$date,"%Y")
df_dateMix <- data.frame(df_dateMonth, df_dateYear)
df_date2014 <- subset(df_dateMix, df_dateYear == 2014)
df_date2015 <- subset(df_dateMix, df_dateYear == 2015)
p1 <- ggplot(df_dateMix, aes(x=df_dateYear)) + geom_bar(colour = "navy", fill = "steelblue")
p2 <- ggplot(df_date2014, aes(x=df_dateMonth)) + geom_bar(colour = "navy", fill = "steelblue")
p3 <- ggplot(df_date2015, aes(x=df_dateMonth)) + geom_bar(colour = "navy", fill = "steelblue")

grid.arrange(p1, p2, p3, nrow=1)
summary(train$date)
```
Se estudian las variable __bedrooms, bathrooms, floors__
```{r}
p1 <- ggplot(train, aes(x=bedrooms)) + geom_bar(colour = "navy", fill = "steelblue")
p2 <- ggplot(train, aes(x=bathrooms)) + geom_bar(colour = "navy", fill = "steelblue")
p3 <- ggplot(train, aes(x=floors)) + geom_bar(colour = "navy", fill = "steelblue")

grid.arrange(p1, p2, p3, nrow=1)
```



### Creamos variables nuevas

__Variables__

Se introducen las variables _saledate, saleyear,salemonth..._

```{r}
train$sale_date = substr(train$date, 1, 8)
train = transform(train, sale_date = as.Date(as.character(sale_date), "%Y%m%d"))
train$sale_year = as.numeric(format(train$sale_date, format="%Y"))
train$sale_month = format(train$sale_date, format="%m")
train$sale_quarter = as.yearqtr(train$sale_date)
#train$sale_quarter = str_sub(train$sale_quarter,-2,-1)
train$sale_tenure =  as.numeric(train$sale_year) - train$yr_built
train$yr_since_last_renovated = ifelse(train$sale_year - train$yr_renovated > 2013, 0, train$sale_year - train$yr_renovated)
train$price_m2 = train$price/train$sqft_living
str(train)
```

### Analisis multivariante cuantitativo

Se estudia en dos tablas las variables cuantitativas

```{r}
AMct01 <- train[, c(3, 6, 20, 7, 21)]
AMct02 <- train[, c(3, 13, 14, 15, 16)]
ggpairs(AMct01)
ggpairs(AMct02)
```

### Analisis multivariante cuantitativo

Se estudia en dos tablas las variables cuanlitativas

```{r}

```

## Detección e imputación de datos

Comentar

### Datos faltantes

Datos faltantes, __NA__

```{r}
colSums(is.na(train))
```

Datos con valor __0__

```{r}
colSums(train==0)
```

### Imputación de datos

Se estudian los NA de sqft_above que se igualaran al valor del sqft_living puesto que en más de la mitad de los datos coinciden

Nº total filas
```{r}
nrow(train)
```
Nº filas coinciden sqft_living y sqft_above
```{r}
sqft_compare <- train[, c(6, 13)]
nrow(subset(sqft_compare, sqft_living == sqft_above))
```

## Transformacion de variables

Transformación _price_

```{r}
train <- mutate(train, price_log10 <- log10(train$price))
train <- mutate(train, price_sqrt <- sqrt(train$price))
train <- mutate(train, price_inv <- 1/(train$price))


p1 <- ggplot(train, aes(x=price)) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p2 <- ggplot(train, aes(x=price_log10 <- log10(train$price))) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p3 <- ggplot(train, aes(x=price_sqrt <- sqrt(train$price))) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
p4 <- ggplot(train, aes(x=price_inv <- 1/(train$price))) + geom_histogram(aes(y=..density..), colour = "navy", fill = "steelblue", bins=30) + geom_density(colour = "goldenrod1", size = 1)
grid.arrange(p1, p2, p3, p4, nrow=2)

qqnorm(train$price)
qqline(train$price)
qqnorm(train$price_log10 <- log10(train$price))
qqline(train$price_log10 <- log10(train$price))
```


## Regresión Lineal

Comentar

```{r}

```


